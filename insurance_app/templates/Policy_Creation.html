<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Policy Creation</title>
  <link rel="icon" href="/static/img/icon.png" type="image/png">
  <link rel="stylesheet" href="../css/common.css" />
  <link rel="stylesheet" href="../css/sidebar.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="../js/sidebar.js"></script>
  <style>
    
    .form-row { display: grid; grid-template-columns: 260px 1fr; gap: 12px; align-items: center; margin-bottom: 12px; }
    .form-row input, .form-row select { padding: 8px; }
    .actions { margin-top: 16px; display: flex; gap: 8px; }
    .btn { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; color: white; font-size: 14px; }
    .btn-primary { background-color: #3b82f6; }
    .btn-secondary { background-color: #64748b; }
    
    /* New Plan & PED Section */
    .new-plan-section {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border: 1px solid #7dd3fc;
      border-radius: 8px;
      padding: 16px 20px;
      margin-bottom: 20px;
    }
    .new-plan-section h3 {
      margin: 0 0 12px 0;
      color: #0369a1;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .new-plan-grid {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 12px;
      align-items: end;
    }
    .new-plan-field label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #475569;
      margin-bottom: 4px;
    }
    .new-plan-field input, .new-plan-field select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      font-size: 14px;
    }
    .new-plan-field input:focus, .new-plan-field select:focus {
      outline: none;
      border-color: #0ea5e9;
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
    }
    .btn-add-plan {
      background: #0ea5e9;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      height: 38px;
    }
    .btn-add-plan:hover { background: #0284c7; }
    .btn-add-plan:disabled { background: #94a3b8; cursor: not-allowed; }
    .plan-added-msg {
      color: #059669;
      font-size: 13px;
      margin-top: 8px;
      display: none;
    }
    .plan-added-msg.show { display: block; }
    .help-text {
      font-size: 11px;
      color: #64748b;
      margin-top: 4px;
    }
    /* PED column styling (kept for top section PED input only, no member grid PED) */
    .pc-ped {
      width: 100%;
      padding: 6px;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      font-size: 13px;
    }
    .pc-ped:focus {
      outline: none;
      border-color: #f59e0b;
      box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
    }
  </style>
</head>
<body data-sidebar="existing-applicant">

  <div class="container">
    <h1>Policy Creation</h1>
    <p>Enter policy details for the approved submission.</p>

    <!-- Inline summary (no heading) -->
    <div class="form-row" style="align-items: center;">
      <div id="summaryLine" style="font-family: inherit; font-size: inherit; padding: 6px 0; white-space: nowrap;">
        <strong>Unique ID:</strong> —   <strong>Proposer Name:</strong> —   <strong>Mobile Number:</strong> —
      </div>
    </div>

    <!-- New Plan & PED Capture Section -->
    <div class="new-plan-section" id="newPlanSection">
      <h3><i class="fas fa-plus-circle"></i> Add Plan & PED</h3>
      <p style="font-size: 12px; color: #64748b; margin: 0 0 12px 0;">
        Select a plan and enter any Pre-Existing Diseases mentioned by the client during tele-verification.
      </p>
      <div class="new-plan-grid">
        <div class="new-plan-field">
          <label for="quickPlanSelect">Select Plan</label>
          <select id="quickPlanSelect">
            <option value="">-- Select a plan --</option>
          </select>
          <div class="help-text">Choose from active plans in the system</div>
        </div>
        <div class="new-plan-field">
          <label for="quickPedInput">PED(s) - Pre-Existing Disease(s)</label>
          <input type="text" id="quickPedInput" placeholder="e.g., Cardiac Problem, Diabetes">
          <div class="help-text">Comma-separated if multiple (e.g., Cardiac, Diabetes)</div>
        </div>
        <button type="button" id="addPlanRowBtn" class="btn-add-plan">
          <i class="fas fa-plus"></i> Add Plan
        </button>
      </div>
      <div id="planAddedMsg" class="plan-added-msg">
        <i class="fas fa-check-circle"></i> <span id="planAddedText">Plan added!</span>
      </div>
    </div>

    <!-- Dynamic tabular form -->
    <div style="margin-top: 12px; overflow-x:auto;">
      <table style="width:100%; border-collapse:collapse; background:#fff;">
        <thead>
          <tr style="background:#f2f2f2;">
            <th style="text-align:left; padding:8px; border:1px solid #eee;">Policy Number</th>
            <th style="text-align:left; padding:8px; border:1px solid #eee;">Member Number</th>
            <th style="text-align:left; padding:8px; border:1px solid #eee;">Member Name</th>
            <th style="text-align:left; padding:8px; border:1px solid #eee;">Plan</th>
            <!-- PED column removed from member grid -->
            <th style="text-align:left; padding:8px; border:1px solid #eee;">Policy Start Date</th>
            <th style="text-align:left; padding:8px; border:1px solid #eee;">Policy Period</th>
            <th style="text-align:left; padding:8px; border:1px solid #eee;">Policy End date</th>
            <th style="text-align:left; padding:8px; border:1px solid #eee; width:100px;">Action</th>
          </tr>
        </thead>
        <tbody id="policyRows"></tbody>
      </table>
      <div style="margin-top:8px;">
        <button id="addRowBtn" class="btn btn-secondary" type="button"><i class="fas fa-plus"></i> Add Row</button>
      </div>
    </div>

    <!-- Application comments -->
    <div class="form-row" style="align-items: start; margin-top: 12px; grid-template-columns: auto 1fr;">
      <label for="appComments" style="font-size: 13px; font-weight: 600; white-space: nowrap;">Comments</label>
      <textarea id="appComments" rows="2" style="min-height:40px; max-width: 520px; width:100%; font-size: 13px;" placeholder="Add any comments for this policy update"></textarea>
    </div>

    <div class="actions">
      <button id="saveBtn" class="btn btn-primary">Save Policy</button>
    </div>

    <!-- Policy Summary Section (hidden initially) -->
    <div id="policySummarySection" style="display: none; margin-top: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
      <h2 style="margin-bottom: 1rem; color: #28a745;">
        <i class="fas fa-check-circle"></i> Policy Created Successfully
      </h2>
      
      <div id="policySummaryContent">
        <!-- Summary will be dynamically inserted here -->
      </div>
      
      <div style="margin-top: 1.5rem;">
        <button onclick="window.location.href='/html/dashboard.html'" class="btn btn-primary">
          <i class="fas fa-home"></i> Back to Dashboard
        </button>
      </div>
    </div>
  </div>
  <script>
    (function(){
      const uid = new URLSearchParams(window.location.search).get('uid') || '';
      const loggedInUserEl = document.getElementById('logged-in-user');
      const backBtn = document.getElementById('btn-approvals');
      const saveBtn = document.getElementById('saveBtn');
      const addRowBtn = document.getElementById('addRowBtn');
      const rowsTbody = document.getElementById('policyRows');
      const summaryLine = document.getElementById('summaryLine');

      try {
        const uidLS = localStorage.getItem('loggedInUserId');
        if (!uidLS) {
          window.location.href = 'Main_login.html';
        }
      } catch {}

      // Initialize plan arrays
      window.clientAgreedPlans = [];
      window.activePlans = [];
      window.teleVerificationPlans = [];      // plans added during tele-verification
      window.allAvailablePlans = [];         // clientAgreedPlans + teleVerificationPlans

      // Fetch active plans from the database (for tele-verification plan selector ONLY)
      async function fetchActivePlans() {
        try {
          const res = await fetch('/api/agent/active_plans');
          if (res.ok) {
            const data = await res.json();
            window.activePlans = data.plans || [];
            console.log('Fetched', window.activePlans.length, 'active plans');
          }
        } catch (e) {
          console.warn('Failed to fetch active plans:', e);
          window.activePlans = [];
        }
      }

      // Combine client agreed plans and tele-verification plans
      function updateAllAvailablePlans() {
        const combined = new Set([
          ...(window.clientAgreedPlans || []),
          ...(window.teleVerificationPlans || [])
        ]);
        window.allAvailablePlans = Array.from(combined).sort();

        // Update the quick plan selector (from active plans)
        const quickSelect = document.getElementById('quickPlanSelect');
        if (quickSelect) {
          const sourcePlans = window.activePlans || [];
          quickSelect.innerHTML = '<option value="">-- Select a plan --</option>' +
            sourcePlans.map(p => `<option value="${p}">${p}</option>`).join('');
        }

        // Refresh plan dropdowns in the member table
        refreshPlanDropdowns();
      }

      // Refresh all plan dropdowns in the table
      function refreshPlanDropdowns() {
        const allPlans = window.allAvailablePlans || [];
        const planOptions = '<option value="">Select a plan</option>' + 
          allPlans.map(p => `<option value="${p}">${p}</option>`).join('');
        
        document.querySelectorAll('.pc-plan').forEach(select => {
          const currentValue = select.value;
          select.innerHTML = planOptions;
          if (currentValue && allPlans.includes(currentValue)) {
            select.value = currentValue;
          }
        });
      }

      // Quick Add Row button handler (tele-verification)
      const addPlanRowBtn = document.getElementById('addPlanRowBtn');
      const quickPlanSelect = document.getElementById('quickPlanSelect');
      const quickPedInput = document.getElementById('quickPedInput');
      const planAddedMsg = document.getElementById('planAddedMsg');
      const planAddedText = document.getElementById('planAddedText');

      if (addPlanRowBtn) {
        addPlanRowBtn.addEventListener('click', function() {
          const selectedPlan = quickPlanSelect?.value || '';
          const ped = (quickPedInput?.value || '').trim();

          if (!selectedPlan) {
            alert('Please select a plan to add.');
            return;
          }

          if (!Array.isArray(window.teleVerificationPlans)) {
            window.teleVerificationPlans = [];
          }

          // Add selected plan to tele-verification list if not already present
          if (!window.teleVerificationPlans.includes(selectedPlan)) {
            window.teleVerificationPlans.push(selectedPlan);
          }

          // Update the set of selectable plans for members
          updateAllAvailablePlans();

          // Show confirmation (note: we are not adding a member row, only making the plan selectable)
          if (planAddedMsg && planAddedText) {
            planAddedText.textContent = ped
              ? `Plan "${selectedPlan}" added with PED note: ${ped}`
              : `Plan "${selectedPlan}" added to selectable plans.`;
            planAddedMsg.classList.add('show');
            setTimeout(() => planAddedMsg.classList.remove('show'), 3000);
          }

          // Clear inputs
          if (quickPlanSelect) quickPlanSelect.value = '';
          if (quickPedInput) quickPedInput.value = '';
        });
      }

      // Prefill Policy holder (memberName) and Member number (mobile) from DB submission
      async function prefillFromSubmission() {
        if (!uid) return;
        try {
          // Fetch active plans first
          await fetchActivePlans();
          
          const res = await fetch(`/api/agent/submission/${encodeURIComponent(uid)}`);
          if (!res.ok) return;
          const data = await res.json();

          // Fetch and store client agreed plans
          if (data && data.Client_Agreed_Plans) {
            try {
              window.clientAgreedPlans = JSON.parse(data.Client_Agreed_Plans);
            } catch (e) {
              window.clientAgreedPlans = [];
              console.error('Failed to parse Client_Agreed_Plans:', e);
            }
          }

          // Initially, allAvailablePlans = clientAgreedPlans (no tele-verification plans yet)
          updateAllAvailablePlans();

          let form = data?.form_summary;
          if (typeof form === 'string') {
            try { form = JSON.parse(form); } catch { form = null; }
          }

          // Utility: deep-search the first value by key name match
          function isPrimitive(val) {
            return (typeof val === 'string' || typeof val === 'number' || typeof val === 'boolean');
          }

          function sanitizeMobile(raw) {
            if (raw === undefined || raw === null) return '';
            const s = String(raw);
            // Extract digits
            const digits = (s.match(/\d+/g) || []).join('');
            // Prefer 10-15 digit sequences typical of phone numbers
            if (digits.length >= 10 && digits.length <= 15) return digits;
            // Fall back to original trimmed string
            return s.trim();
          }

          function findFirstByKeyNames(obj, keys) {
            const seen = new Set();
            function walk(o) {
              if (!o || typeof o !== 'object' || seen.has(o)) return undefined;
              seen.add(o);
              // direct keys
              for (const k of Object.keys(o)) {
                const lower = k.toLowerCase();
                if (keys.some(kk => lower.includes(kk))) {
                  const v = o[k];
                  // Only accept primitives or arrays of primitives
                  if (v !== undefined && v !== null) {
                    if (isPrimitive(v)) {
                      const sv = String(v).trim();
                      if (sv !== '') return sv;
                    } else if (Array.isArray(v)) {
                      const firstPrim = v.find(isPrimitive);
                      if (firstPrim !== undefined && String(firstPrim).trim() !== '') return String(firstPrim).trim();
                    }
                  }
                }
              }
              // nested
              for (const k of Object.keys(o)) {
                const v = o[k];
                const res = walk(v);
                if (res !== undefined) return res;
              }
              return undefined;
            }
            return walk(obj);
          }

          function pickName(obj) {
            if (!obj || typeof obj !== 'object') return '';
            // Look for likely name fields first
            const v = findFirstByKeyNames(obj, ['primary_contact_name','applicant_name','policy_holder','holder_name','full_name','name']);
            return v ? String(v) : '';
          }
          function pickMobile(obj) {
            if (!obj || typeof obj !== 'object') return '';
            const v = findFirstByKeyNames(obj, ['mobile','phone','contact number','mobile no','phone no','contact_number','mobile_no','phone_no']);
            return v ? sanitizeMobile(v) : '';
          }

          let holderName = '';
          let mobileNo = '';
          let memberNames = [];

          // Helper: basic validator to filter out non-name tokens (e.g., 'aadhaar', 'pan')
          function isLikelyName(str) {
            if (!str) return false;
            const s = String(str).trim();
            if (!s) return false;
            const lower = s.toLowerCase();
            // Exclude common non-name tokens and IDs
            const banned = [
              'aadhaar','aadhar','pan','passport','voter','dl','driving','license','licence',
              'policy','number','mobile','phone','contact',
              'cardiac','cancer','diabetes','others'
            ];
            if (banned.some(b => lower.includes(b))) return false;
            // Exclude if mostly digits/symbols
            const letters = s.replace(/[^A-Za-z'\-\.\s]/g, '');
            if (letters.length < Math.ceil(s.length * 0.6)) return false;
            // Likely name pattern: letters, spaces, apostrophes, hyphens, dots
            return /^[A-Za-z][A-Za-z'\-\.\s]*$/.test(s);
          }
          // Try from parsed form JSON
          if (form && typeof form === 'object') {
            // Holder name and mobile
            holderName = pickName(form) || pickName(form.primary_contact || form.primaryContact) || holderName;
            mobileNo = pickMobile(form) || pickMobile(form.primary_contact || form.primaryContact) || mobileNo;

            // Prefer explicit members array if present
            const membersArr = form.members || form.family_members || form.dependents || [];
            if (Array.isArray(membersArr) && membersArr.length) {
              membersArr.forEach(m => {
                const nm = (m && (m.name || m.member_name || m.full_name)) ? String(m.name || m.member_name || m.full_name).trim() : '';
                if (isLikelyName(nm)) memberNames.push(nm);
              });
            } else {
              // Fallback: conservative deep search for name-like fields
              (function collectMemberNames(obj){
                if (obj == null) return;
                if (Array.isArray(obj)) {
                  for (const it of obj) collectMemberNames(it);
                  return;
                }
                if (typeof obj === 'object') {
                  for (const [k,v] of Object.entries(obj)) {
                    const key = String(k).toLowerCase();
                    if (typeof v === 'string' && v.trim() && (key.includes('name') || key.includes('member'))) {
                      if (isLikelyName(v)) memberNames.push(v.trim());
                    }
                    if (v && typeof v === 'object') collectMemberNames(v);
                  }
                }
              })(form);
            }
          }

          // If there are saved policy_details (from a prior save), include member_name values
          try {
            let details = data?.policy_details;
            if (typeof details === 'string' && details.trim()) {
              try { details = JSON.parse(details); } catch { details = null; }
            }
            if (details && typeof details === 'object') {
              const rows = Array.isArray(details.rows) ? details.rows : [];
              for (const r of rows) {
                if (r && r.member_name) memberNames.push(String(r.member_name).trim());
                // If there are existing plans on rows that are NOT in clientAgreedPlans,
                // treat them as tele-verification plans so that dropdowns can display them.
                if (r && r.plan && !window.clientAgreedPlans.includes(r.plan)) {
                  if (!window.teleVerificationPlans.includes(r.plan)) {
                    window.teleVerificationPlans.push(r.plan);
                  }
                }
              }
            }
          } catch {}
          // After including any plans from existing rows, recompute allowed plans
          updateAllAvailablePlans();

          // Fallback: inspect top-level data object (in case values are not inside form_summary)
          if ((!holderName || holderName.trim() === '') && data && typeof data === 'object') {
            holderName = pickName(data) || holderName;
          }
          if ((!mobileNo || mobileNo.trim() === '') && data && typeof data === 'object') {
            mobileNo = pickMobile(data) || mobileNo;
          }
          // Build inline summary line
          if (summaryLine) {
            const u = uid || '—';
            const h = holderName || '—';
            const m = mobileNo || '—';
            summaryLine.innerHTML = `<strong>Unique ID:</strong> ${u}   <strong>Proposer Name:</strong> ${h}   <strong>Mobile Number:</strong> ${m}`;
          }

          // Pull canonical names from backend helper
          try {
            const mnRes = await fetch(`/api/agent/member_names/${encodeURIComponent(uid)}`);
            if (mnRes.ok) {
              const arr = await mnRes.json();
              if (Array.isArray(arr)) memberNames.push(...arr);
            }
          } catch {}

          // Fallbacks and de-duplication
          if (holderName && isLikelyName(holderName)) memberNames.push(holderName);
          // Consider comma-separated names, filtered
          memberNames = memberNames
            .filter(Boolean)
            .flatMap(n => String(n).includes(',') ? String(n).split(',').map(s=>s.trim()).filter(Boolean) : [String(n).trim()])
            .filter(isLikelyName);
          // Deduplicate preserving order
          const seen = new Set();
          memberNames = memberNames.filter(n => (n && !seen.has(n) && seen.add(n)));

          // Initialize first row using defaults (do NOT prefill Member Number)
          addRow({ memberName: memberNames[0] || '' }, memberNames);
          // Save a master member list to avoid duplicating options when adding more rows
          try { window.__memberNamesMaster = memberNames.slice(); } catch {}

          // Check if we should auto-display the summary
          const urlParams = new URLSearchParams(window.location.search);
          const viewMode = urlParams.get('view');
          
          if (viewMode === 'summary') {
            // Load saved policy details and display summary
            await loadAndDisplaySavedPolicy();
          }
        } catch (e) {
          console.warn('Prefill failed', e);
        }
      }

      async function loadAndDisplaySavedPolicy() {
        if (!uid) return;
        
        try {
          const res = await fetch(`/api/agent/submission/${encodeURIComponent(uid)}`);
          if (!res.ok) return;
          const data = await res.json();
          
          // Check if policy has been created
          if (!data.policy_details) {
            alert('No policy details found for this application.');
            return;
          }
          
          let details = data.policy_details;
          if (typeof details === 'string') {
            try { details = JSON.parse(details); } catch { details = null; }
          }
          
          if (!details || !details.rows || !Array.isArray(details.rows)) {
            alert('Invalid policy details format.');
            return;
          }
          
          // Populate the form with saved data
          details.rows.forEach((row, index) => {
            if (index === 0) {
              // First row already exists
              const firstRow = rowsTbody.querySelector('tr');
              if (firstRow) {
                firstRow.querySelector('.pc-number').value = row.policy_number || '';
                firstRow.querySelector('.pc-member-number').value = row.member_number || '';
                firstRow.querySelector('.pc-member-name').value = row.member_name || '';
                firstRow.querySelector('.pc-plan').value = row.plan || '';
                firstRow.querySelector('.pc-start').value = row.policy_start_date || '';
                firstRow.querySelector('.pc-period').value = row.policy_period_months || '12';
                firstRow.querySelector('.pc-end').value = row.policy_end_date || '';
              }
            } else {
              // Add additional rows
              const memberNames = window.__memberNamesMaster || [];
              addRow({
                policyNumber: row.policy_number,
                memberNumber: row.member_number,
                memberName: row.member_name,
                plan: row.plan
              }, memberNames);
              
              // Fill in the new row
              const newRow = rowsTbody.querySelectorAll('tr')[index];
              if (newRow) {
                newRow.querySelector('.pc-plan').value = row.plan || '';
                newRow.querySelector('.pc-start').value = row.policy_start_date || '';
                newRow.querySelector('.pc-period').value = row.policy_period_months || '12';
                newRow.querySelector('.pc-end').value = row.policy_end_date || '';
              }
            }
          });
          
          // Populate comments if available
          if (data.close_comments) {
            const commentsEl = document.getElementById('appComments');
            if (commentsEl) commentsEl.value = data.close_comments;
          }
          
          // Create payload for summary
          const payload = {
            unique_id: uid,
            policy_number: data.policy_number || details.rows[0].policy_number,
            member_number: data.member_number || details.rows[0].member_number,
            member_name: data.member_name || details.rows[0].member_name,
            policy_start_date: data.policy_start_date || details.rows[0].policy_start_date,
            policy_period_months: data.policy_period_months || details.rows[0].policy_period_months,
            close_comments: data.close_comments || ''
          };
          
          // Display the summary
          displayPolicySummary(details.rows, payload);
          
        } catch (e) {
          console.error('Error loading saved policy:', e);
          alert('Failed to load policy details.');
        }
      }

      prefillFromSubmission();

      // Row helpers
      function computeRowEndDate(row){
        const startEl = row.querySelector('.pc-start');
        const periodEl = row.querySelector('.pc-period');
        const endEl = row.querySelector('.pc-end');
        const start = startEl?.value || '';
        const months = parseInt(periodEl?.value || '12', 10);
        // Validate proper HTML date format yyyy-MM-dd before computing
        if (!start || !/^\d{4}-\d{2}-\d{2}$/.test(start)) { if (endEl) endEl.value = ''; return; }
        try {
          const [y,m,d] = start.split('-').map(Number);
          let endYear = y + Math.floor((m - 1 + months) / 12);
          let endMonth = ((m - 1 + months) % 12) + 1;
          const lastDay = new Date(endYear, endMonth, 0).getDate();
          const endDay = Math.min(d, lastDay);
          const mm = String(endMonth).padStart(2,'0');
          const dd = String(endDay).padStart(2,'0');
          if (endEl) endEl.value = `${endYear}-${mm}-${dd}`;
        } catch (e) {
          if (endEl) endEl.value = '';
        }
      }

      function addRow(defaults = {}, memberNames = []){
        // Deduplicate and normalize member list for this row
        let names = Array.isArray(memberNames) ? memberNames.slice() : [];
        names = names
          .map(n => (n == null ? '' : String(n).trim()))
          .filter(Boolean);
        const seenNames = new Set();
        names = names.filter(n => (!seenNames.has(n) && (seenNames.add(n), true)));
        const memberNameOptions = '<option value="">Select a member</option>' + names.map(n => `<option value="${n}">${n}</option>`).join('');

        // Use allAvailablePlans which combines Client Agreed Plans + Tele-Verification Plans
        const allPlans = window.allAvailablePlans || window.clientAgreedPlans || [];
        const planOptions = '<option value="">Select a plan</option>' + allPlans.map(p => `<option value="${p}">${p}</option>`).join('');

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding:6px; border:1px solid #eee;"><input type="text" class="pc-number" placeholder="Policy #" style="width:100%"></td>
          <td style="padding:6px; border:1px solid #eee;"><input type="text" class="pc-member-number" placeholder="Member #" style="width:100%"></td>
          <td style="padding:6px; border:1px solid #eee;">
            <select class="pc-member-name" style="width:100%">
              ${memberNameOptions}
            </select>
          </td>
          <td style="padding:6px; border:1px solid #eee;">
            <select class="pc-plan" style="width:100%">
              ${planOptions}
            </select>
          </td>
          <td style="padding:6px; border:1px solid #eee;"><input type="date" class="pc-start" style="width:100%"></td>
          <td style="padding:6px; border:1px solid #eee;">
            <select class="pc-period" style="width:100%">
              <option value="12">1 year</option>
              <option value="24">2 years</option>
              <option value="36">3 years</option>
            </select>
          </td>
          <td style="padding:6px; border:1px solid #eee;"><input type="date" class="pc-end" style="width:100%" readonly></td>
          <td style="padding:6px; border:1px solid #eee;">
            <button type="button" class="btn btn-secondary pc-remove">Remove</button>
          </td>
        `;
        rowsTbody.appendChild(tr);
        // Apply defaults
        if (defaults.policyNumber) tr.querySelector('.pc-number').value = defaults.policyNumber;
        if (defaults.memberNumber) tr.querySelector('.pc-member-number').value = defaults.memberNumber;
        if (defaults.memberName) tr.querySelector('.pc-member-name').value = defaults.memberName;
        if (defaults.plan) tr.querySelector('.pc-plan').value = defaults.plan;
        // Wire end-date compute
        tr.querySelector('.pc-start').addEventListener('change', () => computeRowEndDate(tr));
        tr.querySelector('.pc-period').addEventListener('change', () => computeRowEndDate(tr));
        // Remove handler
        tr.querySelector('.pc-remove').addEventListener('click', () => tr.remove());
      }

      if (addRowBtn) addRowBtn.addEventListener('click', () => {
        // Prefer the master list computed at prefill time
        let opts = Array.isArray(window.__memberNamesMaster) ? window.__memberNamesMaster.slice() : [];
        if (!opts.length) {
          // Fallback: read from the first select only and de-duplicate
          const firstSel = document.querySelector('.pc-member-name');
          if (firstSel) {
            const seen = new Set();
            opts = Array.from(firstSel.options)
              .map(o => (o.value || '').trim())
              .filter(v => v && !seen.has(v) && (seen.add(v), true));
          }
        }
        addRow({}, opts);
      });

      // Removed Cancel button; Back to Approvals available in header

      saveBtn.addEventListener('click', async function(){
        // First, remove any completely empty rows
        const allRows = Array.from(rowsTbody.querySelectorAll('tr'));
        allRows.forEach(tr => {
          const policyNum = tr.querySelector('.pc-number')?.value.trim() || '';
          const memberNum = tr.querySelector('.pc-member-number')?.value.trim() || '';
          const memberName = tr.querySelector('.pc-member-name')?.value || '';
          const plan = tr.querySelector('.pc-plan')?.value || '';
          const startDate = tr.querySelector('.pc-start')?.value || '';
          
          // If all fields are empty, remove the row
          if (!policyNum && !memberNum && !memberName && !plan && !startDate) {
            tr.remove();
          }
        });
        
        // Extract remaining rows (PED removed from row model)
        const rows = Array.from(rowsTbody.querySelectorAll('tr')).map(tr => ({
          policy_number: tr.querySelector('.pc-number')?.value.trim() || '',
          member_number: tr.querySelector('.pc-member-number')?.value.trim() || '',
          member_name: tr.querySelector('.pc-member-name')?.value || '',
          plan: tr.querySelector('.pc-plan')?.value || '',
          policy_start_date: tr.querySelector('.pc-start')?.value || '',
          policy_period_months: parseInt(tr.querySelector('.pc-period')?.value || '12', 10),
          policy_end_date: tr.querySelector('.pc-end')?.value || ''
        }));
        
        if (!rows.length) { return alert('Please add at least one row with data.'); }
        
        const first = rows[0];
        if (!first.policy_number || !first.member_number || !first.member_name || !first.policy_start_date) {
          return alert('Please fill all required fields in the first row.');
        }
        
        const payload = {
          unique_id: uid,
          policy_number: first.policy_number,
          policy_name: '',
          member_number: first.member_number,
          member_name: first.member_name,
          policy_start_date: first.policy_start_date,
          policy_period_months: first.policy_period_months,
          close_comments: (document.getElementById('appComments')?.value || '').trim(),
          policy_details: JSON.stringify({ rows })
        };
        
        // Disable button during save
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
        
        try {
          const resp = await fetch('/api/agent/policy_details', {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json', 
              'X-User-Id': (localStorage.getItem('loggedInUserId') || 'Unknown') 
            },
            body: JSON.stringify(payload)
          });
          
          if (!resp.ok) {
            const t = await resp.text().catch(()=> '');
            console.error('Save policy failed', resp.status, t);
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Policy';
            return alert('Failed to save policy details');
          }
          
          const data = await resp.json();
          if (data && data.policy_end_date) {
            const firstEndEl = rowsTbody.querySelector('tr .pc-end');
            if (firstEndEl) firstEndEl.value = data.policy_end_date;
          }
          
          // Display summary below the form
          displayPolicySummary(rows, payload);
          
        } catch (e) {
          console.error(e);
          saveBtn.disabled = false;
          saveBtn.textContent = 'Save Policy';
          alert('Failed to save policy details');
        }
      });

      function displayPolicySummary(rows, payload) {
        const summarySection = document.getElementById('policySummarySection');
        const summaryContent = document.getElementById('policySummaryContent');
        
        if (!summarySection || !summaryContent) return;
        
        // Build summary for ALL members/policies
        let html = '';
        
        // Policy overview table showing all members (PED column removed)
        html += `
          <div style="background: white; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
            <h3 style="margin-bottom: 1rem; color: #495057;">
              <i class="fas fa-users"></i> Policy Members (${rows.length})
            </h3>
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: #f8f9fa;">
                  <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Member Name</th>
                  <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Policy Number</th>
                  <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Member Number</th>
                  <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Plan</th>
                  <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Start Date</th>
                  <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">End Date</th>
                  <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Period</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        rows.forEach((row, index) => {
          const periodText = row.policy_period_months === 12 ? '1 year' : 
                            row.policy_period_months === 24 ? '2 years' : 
                            row.policy_period_months === 36 ? '3 years' : 
                            row.policy_period_months + ' months';
          html += `
            <tr style="${index % 2 === 1 ? 'background: #f8f9fa;' : ''}">
              <td style="padding: 10px; border: 1px solid #dee2e6;">${escapeHtml(row.member_name) || '—'}</td>
              <td style="padding: 10px; border: 1px solid #dee2e6;">${escapeHtml(row.policy_number) || '—'}</td>
              <td style="padding: 10px; border: 1px solid #dee2e6;">${escapeHtml(row.member_number) || '—'}</td>
              <td style="padding: 10px; border: 1px solid #dee2e6;"><strong>${escapeHtml(row.plan) || '—'}</strong></td>
              <td style="padding: 10px; border: 1px solid #dee2e6;">${formatDate(row.policy_start_date)}</td>
              <td style="padding: 10px; border: 1px solid #dee2e6;">${formatDate(row.policy_end_date)}</td>
              <td style="padding: 10px; border: 1px solid #dee2e6;">${periodText}</td>
            </tr>
          `;
        });
        
        html += `
              </tbody>
            </table>
          </div>
        `;
        
        // Group rows by plan to show benefits per plan
        const planGroups = {};
        rows.forEach(row => {
          if (row.plan) {
            if (!planGroups[row.plan]) {
              planGroups[row.plan] = [];
            }
            planGroups[row.plan].push(row.member_name);
          }
        });
        
        // Show plan benefits for each unique plan
        const uniquePlans = Object.keys(planGroups);
        if (uniquePlans.length > 0) {
          html += `
            <div style="background: white; padding: 1rem; border-radius: 6px;">
              <h3 style="margin-bottom: 1rem; color: #495057;">
                <i class="fas fa-file-medical"></i> Plan Benefits
              </h3>
          `;
          
          uniquePlans.forEach((planName, idx) => {
            const members = planGroups[planName];
            const memberList = members.map(m => escapeHtml(m)).join(', ');
            const planBenefits = getPlanBenefits(planName);
            
            html += `
              <div style="margin-bottom: 1.5rem; ${idx > 0 ? 'border-top: 1px solid #dee2e6; padding-top: 1rem;' : ''}">
                <h4 style="color: #28a745; margin-bottom: 0.5rem;">
                  <i class="fas fa-check-circle"></i> ${escapeHtml(planName)}
                </h4>
                <p style="color: #6c757d; font-size: 0.9rem; margin-bottom: 0.75rem;">
                  <strong>Members:</strong> ${memberList}
                </p>
                ${planBenefits}
              </div>
            `;
          });
          
          html += `</div>`;
        }
        
        // Add comments if present
        if (payload.close_comments) {
          html += `
            <div style="background: white; padding: 1rem; border-radius: 6px; margin-top: 1rem;">
              <h3 style="margin-bottom: 0.5rem; color: #495057;">
                <i class="fas fa-comment"></i> Comments
              </h3>
              <p style="color: #495057;">${escapeHtml(payload.close_comments)}</p>
            </div>
          `;
        }
        
        summaryContent.innerHTML = html;
        summarySection.style.display = 'block';
        
        // Disable form inputs (make read-only)
        document.querySelectorAll('#policyRows input, #policyRows select, #policyRows button').forEach(el => {
          el.disabled = true;
        });
        addRowBtn.disabled = true;
        saveBtn.disabled = true;
        saveBtn.textContent = 'Policy Saved';
        
        // Scroll to summary
        summarySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
      
      // Helper function to escape HTML to prevent XSS
      function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      function formatDate(dateStr) {
        if (!dateStr) return 'N/A';
        try {
          const date = new Date(dateStr);
          return date.toLocaleDateString('en-IN', { 
            day: '2-digit', 
            month: 'short', 
            year: 'numeric' 
          });
        } catch (e) {
          return dateStr;
        }
      }

      function getPlanBenefits(planName) {
        // PLACEHOLDER: This will be replaced with actual plan data lookup
        // (just for now!!!) return a generic template
        
        if (!planName) {
          return '<p style="color: #6c757d;">Plan benefits information not available.</p>';
        }
        
        return `
          <div style="color: #495057;">
            <p style="margin-bottom: 0.75rem;">
              <strong>Selected Plan:</strong> ${planName}
            </p>
            <div style="background: #fff3cd; padding: 0.75rem; border-radius: 4px; border-left: 4px solid #ffc107; margin-bottom: 1rem;">
              <p style="margin: 0; color: #856404;">
                <i class="fas fa-info-circle"></i> Please refer to your policy documents for complete plan details.
              </p>
            </div>
            <ul style="margin: 0; padding-left: 1.5rem;">
              <li>the first benefit</li>
              <li>the second benefit</li>
              <li>the third benefit</li>
              <li>the fourth benefit</li>
              <li>the fifth benefit</li>
            </ul>
          </div>
        `;
      }

    })();
  </script>
</body>
</html>
