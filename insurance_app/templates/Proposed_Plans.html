<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposed Plans</title>
    <link rel="icon" href="/static/img/icon.png" type="image/png">
    <link rel="stylesheet" href="../static/css/common.css">
    <link rel="stylesheet" href="../static/css/top_bar.css">
    <link rel="stylesheet" href="/static/css/proposed_plans.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="../css/sidebar.css">
</head>
<body data-sidebar="existing-applicant">
    <div class="container">
        <header class="page-header">
            <h1>Proposed Plans</h1>
        </header>
        <main>
            <div id="proposed-container" class="form-container">
                <!-- Proposed plans will be injected here by proposed_plans_v2.js -->
            </div>
            <div class="form-actions">
                <button type="button" id="btn-previous" class="btn btn-secondary">Back</button>
                <button type="button" id="analysis-btn" class="btn btn-info">Select Plan</button>
            </div>
        </main>
    </div>

    <!-- Insert sidebar injector -->
    <script src="../js/sidebar.js"></script>

    <script src="../static/js/proposed_plans_v2.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const loggedInUserEl = document.getElementById('logged-in-user');
            const logoutBtn = document.getElementById('logout-btn');
            const prevBtn = document.getElementById('btn-previous');
            const nextBtn = document.getElementById('btn-next');
            const analysisBtn = document.getElementById('analysis-btn');

            const userId = localStorage.getItem('loggedInUserId');
            // If not logged in at all, bounce to login page
            if (!userId) {
                window.location.href = 'Main_login.html';
                return;
            }

            // Only touch these elements if they actually exist on this page
            if (loggedInUserEl) {
                loggedInUserEl.textContent = userId;
            }
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    localStorage.removeItem('loggedInUserId');
                    window.location.href = 'Main_login.html';
                });
            }

            // Derive unique_id from URL, path, or localStorage
            let uniqueId = null;
            try {
                const urlParams = new URLSearchParams(window.location.search);
                uniqueId = urlParams.get('unique_id');
            } catch(e) {}

            // Fallback: /proposed_plans/<unique_id> style path
            if (!uniqueId) {
                try {
                    const parts = window.location.pathname.split('/').filter(Boolean);
                    const idx = parts.indexOf('proposed_plans');
                    if (idx !== -1 && parts.length > idx + 1) {
                        uniqueId = decodeURIComponent(parts[idx + 1]);
                    }
                } catch(e) {}
            }

            // Fallback: localStorage summary (for brand-new applicants)
            if (!uniqueId) {
                try {
                    const summary = JSON.parse(localStorage.getItem('formSummary'));
                    if (summary && summary.primaryContact) {
                        uniqueId = summary.primaryContact['unique_id']
                            || summary.primaryContact['Unique Id']
                            || null;
                    }
                } catch (e) {}
            }

            // Previous: go back to Summary with same unique_id
            if (prevBtn) {
                prevBtn.addEventListener('click', function() {
                    if (uniqueId) {
                        // Mark return path for Summary back button to preserve state (if you ever use it)
                        try { sessionStorage.setItem('previousFormPage', window.location.pathname); } catch(e) {}
                        window.location.href = `Summary.html?unique_id=${encodeURIComponent(uniqueId)}`;
                    } else {
                        // Last resort: browser history
                        window.history.back();
                    }
                });
            }

            // Next: enable only when the next page exists; default to Analysis_Dashboard.html
            if (nextBtn) {
                let afterPage = null;
                try { afterPage = sessionStorage.getItem('afterPage') || null; } catch(e) {}
                if (!afterPage) { afterPage = 'Analysis_Dashboard.html'; }
                if (afterPage && uniqueId) {
                    const targetUrl = `${afterPage}?unique_id=${encodeURIComponent(uniqueId)}`;
                    fetch(targetUrl, { method: 'GET' })
                        .then(resp => {
                            if (resp && resp.ok) {
                                nextBtn.disabled = false;
                                nextBtn.onclick = () => { window.location.href = targetUrl; };
                            } else {
                                nextBtn.disabled = true;
                            }
                        })
                        .catch(() => { nextBtn.disabled = true; });
                } else {
                    nextBtn.disabled = true;
                }
            }

            // If we navigated here from Analysis_Dashboard, disable Select Plan button
            try {
                const fromFlag = sessionStorage.getItem('fromAnalysisDashboard') === '1';
                const fromRef = document.referrer && document.referrer.indexOf('Analysis_Dashboard.html') !== -1;
                if (analysisBtn && (fromFlag || fromRef)) {
                    // Ensure the action container is interactive again
                    const actionsContainer = document.querySelector('.form-actions');
                    if (actionsContainer) {
                        actionsContainer.classList.remove('disabled');
                        actionsContainer.removeAttribute('aria-disabled');
                    }
                    // Enable navigation buttons (prev/next handled above for afterPage/uniqueId)
                    if (prevBtn) prevBtn.disabled = false;
                    if (nextBtn && !nextBtn.onclick) nextBtn.disabled = true; // will be enabled by afterPage logic if available

                    // Keep Select Plan disabled per requirement
                    analysisBtn.disabled = true;
                    analysisBtn.classList.add('is-disabled');
                    analysisBtn.setAttribute('aria-disabled', 'true');
                    analysisBtn.title = 'Disabled when returning from Analysis Dashboard';
                    // Reset label if it was stuck in progress
                    if (analysisBtn.textContent && analysisBtn.textContent.toLowerCase().includes('selecting')) {
                        analysisBtn.textContent = 'Select Plan';
                    }
                    // One-time flag; clear it so future visits behave normally
                    sessionStorage.removeItem('fromAnalysisDashboard');
                }
            } catch (e) {
                // ignore
            }
        });
    </script>

    <script>
        // Select Plan button â†’ /proposed_plans/<unique_id> (unchanged)
        (function() {
            const analysisBtn = document.getElementById('analysis-btn');
            if (!analysisBtn) return;

            analysisBtn.addEventListener('click', function() {
                if (this.dataset.clicked === 'true') return;
                this.dataset.clicked = 'true';

                this.disabled = true;
                this.textContent = 'Selecting plans...';

                const urlParams = new URLSearchParams(window.location.search);
                const uniqueId = urlParams.get('unique_id');

                if (uniqueId) {
                    window.location.href = `/proposed_plans/${uniqueId}`;
                } else {
                    alert('Could not find a unique ID to analyze.');
                    // Re-enable if navigation is not possible
                    this.disabled = false;
                    this.textContent = 'Select Plan';
                    this.dataset.clicked = 'false';
                }
            });

            // Home button
            (function(){
                const homeBtn = document.getElementById('btn-home');
                if (homeBtn) {
                    homeBtn.addEventListener('click', () => window.location.href = '/html/Health_Insurance_Proposal_Request.html');
                }
            })();
        })();
    </script>
</body>
</html>
