<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="/static/css/logo.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Applicant Request Form</title>
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link rel="stylesheet" href="../css/health_history.css">
    <link rel="stylesheet" href="../css/members.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body data-sidebar="new-applicant">
    <!-- Sidebar will be injected here by sidebar.js -->
    
    <div class="container">
        <header class="page-header">
            <link rel="stylesheet" href="/static/css/logo.css">
            <h1>New Applicant Request Form</h1>
        </header>
        <p style="margin: 2em 0; text-align: center;">Complete the form to help your advisor match you with the right policy. All fields marked * are recommended.</p>
        <form id="insurance-form" novalidate>
            <!-- Tabs will be dynamically inserted here by script.js -->
            <div class="form-actions">
                <button type="button" id="save-btn" class="btn btn-save">Save</button>
                <button type="reset" id="reset-btn" class="btn btn-secondary">Reset</button>
            </div>
        </form>
    </div>
    
    <!-- Load sidebar component first -->
    <script src="../js/sidebar.js"></script>
    
    <!-- Then load other scripts -->
    <script src="../js/calculations.js"></script>
    <script src="../js/validation.js"></script>
    <script src="../js/member_management.js"></script>
    <script src="../js/disease_details.js"></script>
    <script src="../js/comments_noted.js"></script>
    <script src="../js/occupation_data.js"></script>
    <script src="../js/occupation_dropdown.js"></script>
    <script src="../js/progress_bar.js"></script>
    <!-- Main script to load sections -->
    <script src="../js/script.js" defer></script>
    <script src="../js/data_fetch.js" defer></script>
    <script src="../js/form_persistence.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('insurance-form');
            const submitBtn = document.getElementById('submit-btn');
            const previewBtn = document.getElementById('preview-btn');
            const resetBtn = document.getElementById('reset-btn');

            // Deep reset: clears form fields and all dynamic state for New User page
            function hardResetForm() {
                try {
                    // 1) Clear dynamic storage/state
                    localStorage.removeItem('members');
                    localStorage.removeItem('formSummary');
                    localStorage.removeItem('submissionData');
                    localStorage.removeItem('plans');
                    localStorage.removeItem('editMemberId');
                    localStorage.removeItem('comments_noted');
                    sessionStorage.removeItem('currentUniqueId');

                    // 2) Reset all form controls to empty/unchecked/default
                    if (form) {
                        form.reset();
                        const ctrls = form.querySelectorAll('input, select, textarea');
                        ctrls.forEach(el => {
                            const tag = (el.tagName || '').toLowerCase();
                            const type = (el.type || '').toLowerCase();
                            if (tag === 'input') {
                                if (type === 'checkbox' || type === 'radio') {
                                    el.checked = false;
                                } else {
                                    el.value = '';
                                }
                            } else if (tag === 'select') {
                                el.selectedIndex = 0;
                            } else if (tag === 'textarea') {
                                el.value = '';
                            }
                        });
                    }

                    // 3) Clear members UI if present
                    try {
                        const membersList = document.getElementById('members-list');
                        if (membersList) membersList.innerHTML = '';
                        const summaryContent = document.getElementById('summary-content');
                        if (summaryContent) summaryContent.innerHTML = '<p class="placeholder-text">Hover over a member to see their details.</p>';
                        if (window.loadMembersGlobal) window.loadMembersGlobal();
                        if (window.updatePeopleCounter) window.updatePeopleCounter();
                    } catch(e) { /* ignore */ }

                    // 4) Clear comments UI and local mirror
                    try {
                        if (typeof window.clearCommentsSession === 'function') {
                            window.clearCommentsSession();
                        } else {
                            const tb = document.getElementById('comments-tbody');
                            if (tb) tb.innerHTML = '';
                            const tbl = document.getElementById('comments-table');
                            if (tbl) tbl.style.display = 'none';
                            const noMsg = document.getElementById('no-comments-message');
                            if (noMsg) noMsg.style.display = 'block';
                        }
                    } catch(e) { /* ignore */ }

                    // 5) Re-enable action buttons
                    if (submitBtn) submitBtn.disabled = false;
                    if (previewBtn) previewBtn.disabled = false;
                    if (resetBtn) resetBtn.disabled = false;
                } catch (e) {
                    console.warn('Hard reset (new user) encountered an issue:', e);
                }
            }

            if (resetBtn) {
                resetBtn.addEventListener('click', function(ev){
                    ev.preventDefault();
                    hardResetForm();
                });
            }
            
            if (typeof initializePrimaryContactValidation === 'function') {
                initializePrimaryContactValidation();
            }
        });
    </script>
</body>
</html>