<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supervisor Approve</title>
    <link rel="icon" href="/static/img/icon.png" type="image/png">

    <!-- Only these two CSS files -->
    <link rel="stylesheet" href="../css/sidebar.css">
    <link rel="stylesheet" href="../css/supervisor_style.css">

    <!-- Font Awesome -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script defer src="{{ url_for('static', filename='js/plan_selection_summary_v2.js') }}"></script>
</head>

<body data-sidebar="supervisor-form">

    <main class="main-content supervisor-dashboard">
        <header class="page-header">
            <div class="header-left">
                <div>
                    <h1 class="page-title">Supervisor Form</h1>
                    <p class="page-subtitle">Review submitted client applications</p>
                </div>
            </div>
        </header>

        <section class="dashboard-stats card card--flat">
            <div class="stats-container">
                <button class="stat-card stat-total">
                    <div class="stat-value" id="stat-agents">0</div>
                    <div class="stat-label">Agents</div>
                </button>
                <button class="stat-card stat-approved">
                    <div class="stat-value" id="stat-clients">0</div>
                    <div class="stat-label">Clients</div>
                </button>
                <button class="stat-card stat-pending">
                    <div class="stat-value" id="stat-supervisors">0</div>
                    <div class="stat-label">Supervisors</div>
                </button>
            </div>
        </section>

        <section class="card" id="directory-section" style="display:none;">
            <h2 id="directory-title">Directory</h2>
            <div id="directory-summary"></div>
            <div id="directory-content"></div>
        </section>

        <div id="agent-popup" class="agent-popup" role="dialog" aria-hidden="true"></div>

        <section class="card">
            <form class="client-search-form" id="client-search-form">
                <div class="client-search-field">
                    <label for="client-uniqueid-search">Enter Unique ID</label>
                    <input id="client-uniqueid-search" type="text" placeholder="Unique ID">
                </div>
                <button type="button" id="searchBtn" class="btn btn-search">Search</button>
            </form>

            <div id="client-details-content"></div>

            <div id="comprehensive-details-container"></div>

            <div class="form-actions">
                <button class="btn btn-approve" id="approveBtn">Approve</button>
                <button class="btn btn-reject" id="rejectBtn">Reject</button>
            </div>

            <div id="decision-modal" class="modal-backdrop" aria-hidden="true">
                <div class="modal">
                    <h3 id="decision-modal-title">Supervisor Notes</h3>
                    <p style="margin-top:0;color:#555">
                        Please provide notes for this decision. This field is mandatory.
                    </p>

                    <div id="sup-selected-summary" style="display:none;"></div>

                    <textarea id="decision-comments"
                              placeholder="Enter your notes..."></textarea>

                    <div class="modal-actions">
                        <button id="decision-cancel" class="btn btn-secondary">
                            Cancel
                        </button>

                        <button id="decision-confirm" class="btn">
                            Confirm
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="toast-notification" class="toast"></div>

    <button class="mobile-menu-btn" id="mobile-menu-btn" aria-label="Toggle navigation">
        <i class="fas fa-bars"></i>
    </button>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <script src="../js/sidebar.js"></script>

    <script>
        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.className = 'toast show';
            setTimeout(() => {
                toast.className = toast.className.replace('show', '');
            }, 3000);
        }

        function buildSection(title, data) {
            let sectionHtml = `<fieldset><legend>${title}</legend><div class="summary-grid">`;
            for (const [key, value] of Object.entries(data || {})) {
                if (value !== null && value !== undefined && value !== '') {
                    const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    sectionHtml += `<div class="summary-item"><strong>${formattedKey}:</strong> ${value}</div>`;
                }
            }
            sectionHtml += `</div></fieldset>`;
            return sectionHtml;
        }

        function buildSummaryHTML(summaryData = {}) {
            let html = '';
            if (summaryData.primaryContact) {
                html += buildSection('Primary Contact', summaryData.primaryContact);
            }
            if (summaryData.healthHistory) {
                html += buildSection('Proposer\'s Health Details', summaryData.healthHistory);
            }
            if (summaryData.members && summaryData.members.length) {
                html += '<fieldset><legend>Members to be Covered</legend>';
                summaryData.members.forEach(member => {
                    html += '<div class="summary-member-card">';
                    const memberFieldsOrder = [
                        'name', 'relationship', 'occupation', 'gender', 'dob', 'age',
                        'height', 'weight', 'bmi', 'plannedSurgeries', 'smoker',
                        'alcohol', 'riskyHobbies'
                    ];
                    memberFieldsOrder.forEach(field => {
                        const fieldValue = member[field];
                        if (fieldValue) {
                            const formattedKey = field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            html += `<div class="summary-item"><strong>${formattedKey}:</strong> ${fieldValue}</div>`;
                        }
                    });
                    if (member.healthHistory && typeof member.healthHistory === 'object') {
                        Object.entries(member.healthHistory).forEach(([disease, detail]) => {
                            if (!disease || !detail) return;
                            const formattedKey = disease.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) + ' Details';
                            html += `<div class="summary-item"><strong>${formattedKey}:</strong> ${detail}</div>`;
                        });
                    }
                    html += '</div>';
                });
                html += '</fieldset>';
            }
            if (summaryData.coverAndCost) {
                html += buildSection('Cover & Cost Preferences', summaryData.coverAndCost);
            }
            if (summaryData.existingCoverage) {
                html += buildSection('Existing Coverage & Portability', summaryData.existingCoverage);
            }
            if (summaryData.claimsAndService) {
                html += buildSection('Claims & Service History', summaryData.claimsAndService);
            }
            if (summaryData.financeAndDocumentation) {
                html += buildSection('Finance & Documentation', summaryData.financeAndDocumentation);
            }
            if (summaryData.otherNotes) {
                html += buildSection('Other Notes', summaryData.otherNotes);
            }
            return html;
        }

        function renderProposedPlansList(proposed) {
            if (!proposed || typeof proposed !== 'object' || Object.keys(proposed).length === 0) {
                return '<p>No proposed plans available.</p>';
            }
            let html = '';
            Object.keys(proposed).forEach(key => {
                const info = proposed[key] || {};
                const memberName = info.name || (key === 'comprehensive_cover' ? 'Family' : key) || 'Member';
                const list = Array.isArray(info.plans) ? info.plans : [];
                html += '<div class="member-plan-section">';
                html += `<h2>${memberName}</h2>`;
                html += '<ul>';
                if (list.length) {
                    list.forEach(p => { html += `<li>${p}</li>`; });
                } else {
                    html += '<li>No specific plans found for this member.</li>';
                }
                html += '</ul>';
                html += '</div>';
            });
            return html;
        }

        function renderChosenPlans(plans) {
            if (!plans || plans.length === 0) return '<p>No plans chosen yet.</p>';
            let listHtml = '<ul>';
            plans.forEach(plan => {
                listHtml += `<li>${plan}</li>`;
            });
            listHtml += '</ul>';
            return listHtml;
        }

        function renderComprehensiveDetails(data) {
            const container = document.getElementById('comprehensive-details-container');
            const rawStatus = (data.supervisor_status || 'SUP_REVIEW');
            const statusUpper = rawStatus.toUpperCase();
            const statusClass = `status-${statusUpper.toLowerCase()}`;
            container.innerHTML = `
                <div class="status-row">
                    <strong>Supervisor Status:</strong>
                    <span id="supervisor-status" class="status-badge ${statusClass}">${statusUpper}</span>
                </div>
                <div class="accordion">
                    <div class="accordion-item">
                        <button class="accordion-header">Form Summary</button>
                        <div class="accordion-content">
                            ${buildSummaryHTML(data.summary)}
                        </div>
                    </div>
                    <div class="accordion-item">
                        <button class="accordion-header">System Proposed Plans</button>
                        <div class="accordion-content">
                            ${renderProposedPlansList(data.proposed_plans)}
                        </div>
                    </div>
                    <div class="accordion-item">
                        <button class="accordion-header">Selection Summary (Agent vs Supervisor)</button>
                        <div class="accordion-content">
                            <div id="selection-summary-matrix"></div>
                        </div>
                    </div>
                </div>
            `;

            try {
                if (data && data.proposed_plans) {
                    window._proposedPlans = data.proposed_plans;
                }
                try {
                    let agentChosen = [];
                    if (Array.isArray(data.chosen_plans)) agentChosen = data.chosen_plans.slice();
                    else if (typeof data.plans_chosen === 'string') {
                        try {
                            const parsed = JSON.parse(data.plans_chosen);
                            if (Array.isArray(parsed)) agentChosen = parsed;
                        } catch {}
                    }
                    window._agentSelected = agentChosen;
                } catch {}
            } catch(e) {}

            const accordionHeaders = document.querySelectorAll('.accordion-header');
            accordionHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    header.classList.toggle('active');
                    const content = header.nextElementSibling;
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                    } else {
                        content.style.maxHeight = content.scrollHeight + 'px';
                    }
                    try {
                        if ((header.textContent || '').includes('Selection Summary')) {
                            if (typeof window._renderSupSummary === 'function') {
                                window._renderSupSummary();
                            }
                        }
                    } catch(e) {}
                });
            });

            try {
                const host = document.getElementById('selection-summary-matrix');
                if (host) {
                    window._renderSupSummary = async function(uidParam){
                        const uid = uidParam || (document.getElementById('client-uniqueid-search')?.value || '').trim() || '';
                        if (!uid) return;
                        try {
                            let ps = null;
                            let r = await fetch(`/plan_summary/${encodeURIComponent(uid)}`);
                            if (!r.ok) {
                                try {
                                    const fallback = (window._proposedPlans && typeof window._proposedPlans === 'object') ? window._proposedPlans : {};
                                    if (Object.keys(fallback).length) {
                                        await fetch(`/plan_summary/${encodeURIComponent(uid)}/init_or_update`, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ proposed: fallback })
                                        });
                                        r = await fetch(`/plan_summary/${encodeURIComponent(uid)}`);
                                    }
                                } catch(e) {}
                            }
                            if (!r.ok) throw new Error('load failed');
                            ps = await r.json();
                            let proposed = ps.proposed || {};
                            try {
                                if (proposed && proposed.comprehensive_cover) {
                                    if (!proposed.comprehensive_cover.name) proposed.comprehensive_cover.name = 'Family';
                                }
                            } catch {}
                            let agentSel = new Set(Array.isArray(ps.agent_selected) ? ps.agent_selected : (Array.isArray(ps.agent_selected_plans) ? ps.agent_selected_plans : []));
                            if (agentSel.size === 0 && Array.isArray(window._agentSelected)) {
                                agentSel = new Set(window._agentSelected);
                            }
                            const supSel = new Set(ps.supervisor_selected || []);
                            if (!proposed || Object.keys(proposed).length === 0) {
                                try {
                                    const fallback = (window._proposedPlans && typeof window._proposedPlans === 'object') ? window._proposedPlans : {};
                                    if (Object.keys(fallback).length) {
                                        await fetch(`/plan_summary/${encodeURIComponent(uid)}/init_or_update`, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ proposed: fallback })
                                        });
                                        const r2 = await fetch(`/plan_summary/${encodeURIComponent(uid)}`);
                                        if (r2.ok) {
                                            const ps2 = await r2.json();
                                            proposed = ps2.proposed || fallback;
                                        } else {
                                            proposed = fallback;
                                        }
                                    }
                                } catch {}
                            }
                            window.renderPlanSelectionSummary(host, {
                                proposed,
                                agentSel,
                                supervisorSel: supSel,
                                mode: 'supervisor',
                                onSupervisorToggle: async (planName, checked) => {
                                    try {
                                        if (checked) supSel.add(planName); else supSel.delete(planName);
                                        await fetch(`/plan_summary/${encodeURIComponent(uid)}/supervisor`, {
                                            method: 'PATCH',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ supervisor_selected: Array.from(supSel) })
                                        });
                                    } catch {}
                                    try {
                                        const modal = document.getElementById('decision-modal');
                                        if (modal && modal.style.display === 'flex' && typeof buildSupervisorSelectionSummary === 'function'){
                                            const box = document.getElementById('sup-selected-summary');
                                            if (box) box.innerHTML = buildSupervisorSelectionSummary();
                                        }
                                    } catch {}
                                }
                            });
                            try { window._proposedPlans = proposed; } catch(e) {}
                        } catch (e) {
                            host.innerHTML = '<div style="padding:8px; color:#b91c1c;">Unable to load plan summary.</div>';
                        }
                    }
                }
            } catch (e) { console.error(e); }
        }

        async function updateApprovalStatus(uniqueId, status, comments) {
            if (!uniqueId) {
                showToast('Please search for a client first.');
                return;
            }
            if (!comments || !comments.trim()) {
                showToast('Comments are required.');
                return;
            }
            try {
                const response = await fetch(`/update_approval_status/${uniqueId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Id': (localStorage.getItem('loggedInUserId') || 'Unknown')
                    },
                    body: JSON.stringify({ status: status, comments: comments.trim() })
                });
                const result = await response.json();
                if (response.ok) {
                    showToast(`Client form has been approved.`);
                    const badge = document.getElementById('supervisor-status');
                    if (badge) {
                        const newUpper = status.toUpperCase();
                        badge.textContent = newUpper;
                        badge.className = `status-badge status-${newUpper.toLowerCase()}`;
                    }
                } else {
                    showToast(`Error: ${result.error}`);
                }
            } catch (err) {
                console.error('Error updating status:', err);
                showToast('An error occurred while updating the status.');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const logoutBtn = document.querySelector('.btn-logout');
            const searchBtn = document.querySelector('.btn-search');
            const approveBtn = document.querySelector('.btn-approve');
            const rejectBtn = document.querySelector('.btn-reject');
            const detailsContainer = document.getElementById('client-details-content');
            const searchInput = document.getElementById('client-uniqueid-search');
            let lastFetchedStatus = '';
            let lastSearchedId = '';

            function normalizeStatus(s) {
                return (s || '').toString().trim().toUpperCase();
            }

            function setDecisionButtonsEnabled(enabled) {
                approveBtn.disabled = !enabled;
                rejectBtn.disabled = !enabled;
            }

            function setButtonsByStatus(status, hasId) {
                const s = normalizeStatus(status);
                const enable = !!hasId && s === 'SUP_REVIEW';
                setDecisionButtonsEnabled(enable);
            }

            setDecisionButtonsEnabled(false);

            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    localStorage.removeItem('loggedInUserId');
                    window.location.href = 'Main_login.html';
                });
            }

            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    const val = searchInput.value.trim();
                    if (!val || val !== lastSearchedId) {
                        setDecisionButtonsEnabled(false);
                    }
                });
            }

            if (searchBtn) {
                searchBtn.addEventListener('click', async () => {
                    const uniqueId = searchInput.value.trim();
                    if (!uniqueId) return;
                    const originalLabel = searchBtn.textContent;
                    searchBtn.disabled = true;
                    searchBtn.textContent = 'Fetching...';
                    detailsContainer.innerHTML = '<p>Fetching data...</p>';
                    document.getElementById('comprehensive-details-container').innerHTML = '';
                    try {
                        const response = await fetch('/client_details/' + encodeURIComponent(uniqueId));
                        if (response.ok) {
                            const data = await response.json();
                            detailsContainer.innerHTML = '';
                            renderComprehensiveDetails(data);
                            lastFetchedStatus = normalizeStatus(data.supervisor_status);
                            lastSearchedId = uniqueId;
                            setButtonsByStatus(lastFetchedStatus, true);
                            try {
                                if (typeof window._renderSupSummary === 'function') {
                                    window._renderSupSummary(uniqueId);
                                }
                            } catch {}
                        } else {
                            const msg = await response.text().catch(()=> '');
                            console.error('Fetch failed', response.status, msg);
                            detailsContainer.innerHTML = `<p>No record found for ID: ${uniqueId}</p>`;
                            lastFetchedStatus = '';
                            lastSearchedId = '';
                            setDecisionButtonsEnabled(false);
                        }
                    } catch (err) {
                        console.error(err);
                        detailsContainer.innerHTML = '<p>Error fetching data.</p>';
                        setDecisionButtonsEnabled(false);
                    } finally {
                        searchBtn.disabled = false;
                        searchBtn.textContent = originalLabel;
                    }
                });
            }

            (function autoSearchFromQuery() {
                try {
                    const params = new URLSearchParams(window.location.search);
                    const uidParam = params.get('uid');
                    if (!uidParam) return;

                    if (searchInput) {
                        searchInput.value = uidParam;
                    }

                    setTimeout(() => {
                        console.log('Supervisor_Form: auto-searching for uid:', uidParam);
                        if (searchBtn) {
                            if ((searchInput?.value || '').trim()) {
                                searchBtn.click();
                            }
                        } else {
                            console.warn('Supervisor_Form: searchBtn not found â€” cannot auto-click. Check element IDs.');
                        }
                    }, 60);
                } catch (e) {
                    console.error('Auto-search error:', e);
                }
            })();

            const modal = document.getElementById('decision-modal');
            const modalTitle = document.getElementById('decision-modal-title');
            const commentsEl = document.getElementById('decision-comments');
            const confirmBtn = document.getElementById('decision-confirm');
            const cancelBtn = document.getElementById('decision-cancel');
            let pendingDecision = null;

            function collectSupervisorMatrixSelections(){
                const host = document.getElementById('selection-summary-matrix');
                const chosen = [];
                if (host) {
                    const boxes = host.querySelectorAll('input.pss-sup, input.sup-matrix');
                    boxes.forEach(b => { if (b.checked) { const name = b.getAttribute('data-plan-name'); if (name) chosen.push(name); } });
                    if (chosen.length) return chosen;
                }
                try {
                    const saved = JSON.parse(localStorage.getItem('supervisor_matrix_choices') || '{}');
                    const keys = Object.keys(saved).filter(k => !!saved[k]);
                    if (keys && keys.length) return keys;
                } catch {}
                try {
                    if (Array.isArray(window._loadedDataSupervisorSel)) return window._loadedDataSupervisorSel.slice();
                } catch {}
                return [];
            }

            function buildSupervisorSelectionSummary(){
                try {
                    const proposed = (window._proposedPlans && typeof window._proposedPlans === 'object') ? window._proposedPlans : {};
                    const selectedArr = collectSupervisorMatrixSelections();
                    const selected = new Set(selectedArr);
                    const keys = Object.keys(proposed);
                    if (proposed && proposed.comprehensive_cover && keys.includes('comprehensive_cover')) {
                        keys.splice(keys.indexOf('comprehensive_cover'), 1);
                        keys.unshift('comprehensive_cover');
                    }
                    let parts = [];
                    parts.push('<div style="font-weight:700; margin-bottom:6px;">Supervisor approved plans</div>');
                    keys.forEach(k => {
                        const info = proposed[k] || {};
                        const sectionName = info.name || (k === 'comprehensive_cover' ? 'Family' : k);
                        const list = Array.isArray(info.plans) ? info.plans : [];
                        const chosenForSection = list.filter(p => selected.has(p));
                        if (chosenForSection.length) {
                            parts.push(`<div style="margin:4px 0; font-weight:600;">${sectionName}</div>`);
                            chosenForSection.forEach(plan => {
                                parts.push(`<div style="margin-left:8px;">${plan}</div>`);
                            });
                        }
                    });
                    if (!keys.length && selected.size) {
                        parts.push('<div style="margin:4px 0; font-weight:600;">Selected plans</div>');
                        Array.from(selected).forEach(plan => parts.push(`<div style="margin-left:8px;">${plan}</div>`));
                    }
                    if (parts.length <= 1) {
                        parts.push('<div style="color:#888;">No selections</div>');
                    }
                    return parts.join('');
                } catch (e) {
                    return '<div style="color:#888;">No selections</div>';
                }
            }

            function openDecisionModal(type) {
                const map = { approved: 'sup_approved', rejected: 'sup_rejected', sup_approved: 'sup_approved', sup_rejected: 'sup_rejected' };
                pendingDecision = map[type] || type;
                commentsEl.value = '';
                const titleKey = pendingDecision === 'sup_approved'
                    ? 'SUP_APPROVED'
                    : (pendingDecision === 'sup_rejected'
                        ? 'SUP_REJECTED'
                        : String(pendingDecision).toUpperCase());
                modalTitle.textContent = `Supervisor Notes for ${titleKey}`;
                try {
                    const box = document.getElementById('sup-selected-summary');
                    if (box) {
                        if (pendingDecision === 'sup_approved') {
                            box.style.display = '';
                            box.innerHTML = buildSupervisorSelectionSummary();
                        } else {
                            box.style.display = 'none';
                            box.innerHTML = '';
                        }
                    }
                } catch (e) {}
                modal.style.display = 'flex';
                modal.setAttribute('aria-hidden', 'false');
                commentsEl.focus();
            }

            function closeDecisionModal() {
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
                pendingDecision = null;
            }

            if (approveBtn) {
                approveBtn.addEventListener('click', () => openDecisionModal('sup_approved'));
            }
            if (rejectBtn) {
                rejectBtn.addEventListener('click', () => openDecisionModal('sup_rejected'));
            }
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => closeDecisionModal());
            }

            if (confirmBtn) {
                confirmBtn.addEventListener('click', async () => {
                    const uniqueId = searchInput.value.trim();
                    const comments = commentsEl.value;
                    if (!pendingDecision) return;
                    if (!comments || !comments.trim()) {
                        showToast('Comments are required.');
                        return;
                    }

                    try {
                        if (pendingDecision === 'sup_approved') {
                            const selectedPlans = collectSupervisorMatrixSelections();

                            if (!selectedPlans || selectedPlans.length === 0) {
                                showToast('Please select at least one plan before approving.');
                                return;
                            }

                            await fetch(`/supervisor_selected_plans/${encodeURIComponent(uniqueId)}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-User-Id': (localStorage.getItem('loggedInUserId') || 'Unknown')
                                },
                                body: JSON.stringify({ selected_plans: selectedPlans })
                            });
                        }

                        await updateApprovalStatus(uniqueId, pendingDecision, comments);
                        lastFetchedStatus = normalizeStatus(pendingDecision);
                        setButtonsByStatus(lastFetchedStatus, true);
                        closeDecisionModal();
                    } catch (err) {
                        console.error('Error submitting decision:', err);
                        showToast('An error occurred while submitting the decision.');
                    }
                });
            }


            // Load dashboard stats for supervisor mini-cards
            fetch('/stats')
                .then(response => response.json())
                .then(data => {
                    const agentsEl = document.getElementById('stat-agents');
                    const clientsEl = document.getElementById('stat-clients');
                    const supervisorsEl = document.getElementById('stat-supervisors');

                    if (agentsEl && typeof data.agents !== 'undefined') {
                        agentsEl.textContent = data.agents;
                    }
                    if (clientsEl && typeof data.clients !== 'undefined') {
                        clientsEl.textContent = data.clients;
                    }
                    if (supervisorsEl && typeof data.supervisors !== 'undefined') {
                        supervisorsEl.textContent = data.supervisors;
                    }
                })
                .catch(err => console.error('Error fetching stats:', err));
        });
    </script>
</body>
</html>
