<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Disabled page logo: removing CSS/JS that injects the brand image -->
    <!-- <link rel="stylesheet" href="/static/css/logo.css"> -->
    <!-- <script defer src="/static/js/logo.js"></script> -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan Analysis Dashboard - {{ unique_id }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/top_bar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/analysis_dashboard.css') }}">
    <script defer src="{{ url_for('static', filename='js/plan_selection_summary_v2.js') }}"></script>
    <style>
        /* Match status box styling used in Existing_Applicant_Request_Form.html */
        .comment-box { border:1px solid #ccc; padding:8px; min-height:40px; background:#fff; }
    </style>
</head>
<body>
    <header class="top-bar">
    <!-- Disabled duplicate logo includes in header -->
    <!-- <link rel="stylesheet" href="/static/css/logo.css"> -->
    <!-- <script defer src="/static/js/logo.js"></script> -->
        <div class="user-info">
            Logged in as: <span id="logged-in-user" class="user-id"></span>
        </div>
        <div class="right-actions">
            <button id="btn-home" class="btn">Home</button>
            <button id="logout-btn" class="btn btn-logout">Logout</button>
        </div>
    </header>
    <script type="application/json" id="client-data-json">{{ (client_data or {})|tojson|safe }}</script>
    <script type="application/json" id="analysis-data-json">{{ (analysis or {})|tojson|safe }}</script>
    <script type="application/json" id="supervisor-status-json">{{ (supervisor_status or "")|tojson|safe }}</script>
    <script type="application/json" id="supervisor-comments-json">{{ (supervisor_comments or "")|tojson|safe }}</script>
    <script type="application/json" id="supervisor-modified-at-json">{{ (supervisor_modified_at or "")|tojson|safe }}</script>
    <script type="application/json" id="supervisor-modified-by-json">{{ (supervisor_modified_by or "")|tojson|safe }}</script>

    <div class="container">
        <div class="page-header">
            <h1>Plan Analysis Dashboard</h1>
            <p><strong>Client ID:</strong> {{ unique_id }}</p>
        </div>

        <section id="supervisor-meta" class="section supervisor-meta" style="display:none;">
            <div class="form-group" style="margin-top:8px;">
                <div><strong>Status</strong></div>
                <div id="sup-summary" class="comment-box" role="textbox" aria-readonly="true" style="white-space:normal; font-family: inherit; font-size: inherit; line-height:1.2; min-height: 48px; padding:0; margin:0;"></div>
            </div>
        </section>

        <div id="supervisor-comments-block" class="supervisor-comments is-hidden">
            <h3>Supervisor Comments</h3>
            <p id="supervisor-comments-text"></p>
        </div>

        <section class="personal-info" id="personalInfo"></section>

        <section class="plan-options-section">
            <div class="tabs">
                <button id="tab-btn-best-floater" name="tab-btn-best-floater" class="tab-link active" data-tab="tab-best-floater">Family</button>
                <button id="tab-btn-combinations" name="tab-btn-combinations" class="tab-link" data-tab="tab-combinations">Individual</button>
                <button id="tab-btn-browse-all" name="tab-btn-browse-all" class="tab-link" data-tab="tab-browse-all">All plans</button>
            </div>

            <div id="tab-best-floater" class="tab-content active">
                <div class="cards-container vertical" id="floater-plans-container">
                    <!-- Option 1: Best Family Floater plans will be rendered here by JS -->
                </div>
            </div>

            <div id="tab-combinations" class="tab-content">
                <div id="combo-packages-container">
                    <!-- Option 2 & 3: Combination packages will be rendered here by JS -->
                </div>
            </div>

            <div id="tab-browse-all" class="tab-content">
                <div id="plans-table">
                    <h2>All Ranked Plans</h2>
                    <p>The following plans have been scored based on how well they fit the entire family's needs, including specific ailments.</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Plan Name</th>
                                <th>Policy Cover</th>
                                <th>Category</th>
                                <th>Ailment Score</th>
                                {% if analysis.member_score_columns %}
                                    {% for col_name in analysis.member_score_columns %}
                                        <th>{{ col_name.replace('Score_', '') }} Score</th>
                                    {% endfor %}
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for plan in analysis.browse_all %}
                                <tr>
                                    <td><span class="badge">{{ loop.index }}</span></td>
                                    <td>{{ plan['Plan Name'] }}</td>
                                    <td>{{ plan.get('Policy_Code', '') }}</td>
                                    <td>{{ plan.Category }}</td>
                                    <td>{{ '%.2f'|format(plan.AilmentScore|float) }}</td>
                                    {% if analysis.member_score_columns %}
                                        {% for col_name in analysis.member_score_columns %}
                                            <td>{{ '%.2f'|format(plan[col_name]|float) }}</td>
                                        {% endfor %}
                                    {% endif %}
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="{{ 5 + (analysis.member_score_columns|length if analysis.member_score_columns else 0) }}">No ranked plans available.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <div class="form-actions" style="text-align: left; padding-top: 20px;">
            <button type="button" id="back-btn" name="back-btn" class="btn btn-secondary">Back</button>
            {% set sup = (supervisor_status or '') | string | lower %}
            <button type="button"
                    id="proceedBtn"
                    name="proceedBtn"
                    class="btn btn-secondary{% if sup in ['approved','pending'] %} is-disabled{% endif %}"
                    {% if sup in ['approved','pending'] %}disabled aria-disabled="true" title="Disabled due to supervisor status"{% endif %}>
                Proceed
            </button>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/analysis_dashboard.js') }}" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const loggedInUserEl = document.getElementById('logged-in-user');
            const logoutBtn = document.getElementById('logout-btn');
            const homeBtn = document.getElementById('btn-home');
            const userId = localStorage.getItem('loggedInUserId');
            if (userId) {
                loggedInUserEl.textContent = userId;
            } else {
                // Use absolute path to avoid 404s from relative redirects
                window.location.href = '/';
            }
            logoutBtn.addEventListener('click', function() {
                localStorage.removeItem('loggedInUserId');
                // Hit the Flask logout endpoint which redirects to '/'
                window.location.href = '/logout';
            });
            if (homeBtn) {
                homeBtn.addEventListener('click', () => window.location.href = '/html/Health_Insurance_Proposal_Request.html');
            }

            // Back button: set a flag so Proposed_Plans disables Select Plan when returning from here
            (function(){
                const backBtn = document.getElementById('back-btn');
                if (backBtn) {
                    backBtn.addEventListener('click', function(ev){
                        try { sessionStorage.setItem('fromAnalysisDashboard', '1'); } catch(e) {}
                        window.history.back();
                    });
                }
            })();

            // Show supervisor status summary (mirroring Existing_Applicant_Request_Form.html)
            (function(){
                const supSection = document.getElementById('supervisor-meta');
                const supSummary = document.getElementById('sup-summary');
                if (!supSummary) return;
                try {
                    const supJsonEl = document.getElementById('supervisor-status-json');
                    const commentsJsonEl = document.getElementById('supervisor-comments-json');
                    const modifiedAtJsonEl = document.getElementById('supervisor-modified-at-json');
                    const modifiedByJsonEl = document.getElementById('supervisor-modified-by-json');
                    
                    const statusRaw = supJsonEl ? JSON.parse(supJsonEl.textContent) : null;
                    const commentsRaw = commentsJsonEl ? JSON.parse(commentsJsonEl.textContent) : null;
                    const modifiedAtRaw = modifiedAtJsonEl ? JSON.parse(modifiedAtJsonEl.textContent) : null;
                    const modifiedByRaw = modifiedByJsonEl ? JSON.parse(modifiedByJsonEl.textContent) : null;
                    
                    const statusDisp = (statusRaw && String(statusRaw).trim()) ? statusRaw : 'Open';
                    const comments = (commentsRaw && String(commentsRaw).trim()) ? commentsRaw : 'No comments';
                    let by = '—';
                    
                    // Use the timestamp from the template data
                    let tsStr = '—';
                    if (modifiedAtRaw) {
                        const isoTry = new Date(modifiedAtRaw);
                        if (!isNaN(isoTry.getTime())) {
                            tsStr = isoTry.toLocaleString();
                        } else if (typeof modifiedAtRaw === 'string') {
                            const parts = modifiedAtRaw.split('_');
                            if (parts.length === 2) {
                                const datePart = parts[0];
                                const timePart = parts[1].replace(/-/g, ':');
                                const iso = `${datePart}T${timePart}`;
                                const d = new Date(iso);
                                if (!isNaN(d.getTime())) tsStr = d.toLocaleString();
                            }
                        }
                    }
                    
                    // Use the modified by from template data
                    by = modifiedByRaw || '—';
                    
                    const summaryHtml = '<strong>Application Status:</strong> ' + statusDisp + '<br>' +
                                       '<strong>Comments:</strong> ' + comments + '<br>' +
                                       '<strong>Last Updated by:</strong> ' + by + ' <strong>Last Updated at:</strong> ' + tsStr;
                    supSummary.innerHTML = summaryHtml;
                    if (supSection) supSection.style.display = '';
                } catch (e) {
                    if (supSection) supSection.style.display = '';
                }
            })();
        });
    </script>

    <div id="confirmationModal" class="modal-overlay is-hidden">
        <div class="modal-content" style="max-width:900px; width:90vw; max-height:80vh; display:flex; flex-direction:column;">
            <button class="modal-close" id="closeModalBtn" name="closeModalBtn" aria-label="Close">&times;</button>
            <h2>Plans Selection Summary</h2>
            <div id="planSelectionSummary" style="overflow:auto; flex:1; min-height:0; padding:4px;"></div>
            <div class="modal-actions" style="margin-top:8px; display:flex; gap:8px; justify-content:flex-end;">
                <button type="button" id="confirmSelection" class="btn">Confirm</button>
                <button type="button" id="cancelSelection" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <script>
    // Build and show confirmation table when clicking Proceed
    (function(){
        const proceedBtn = document.getElementById('proceedBtn');
        const modal = document.getElementById('confirmationModal');
        const closeBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelSelection');
        const confirmBtn = document.getElementById('confirmSelection');
        const summaryHost = document.getElementById('planSelectionSummary');

        function showModal(){ if (modal) modal.classList.remove('is-hidden'); }
        function hideModal(){ if (modal) modal.classList.add('is-hidden'); }

        function escapeHtml(s){ const d=document.createElement('div'); d.textContent=String(s||''); return d.innerHTML; }

        function getUniqueId(){
            try{
                const u = new URLSearchParams(window.location.search).get('unique_id');
                if (u) return u;
                const fs = JSON.parse(localStorage.getItem('formSummary'));
                return fs && fs.primaryContact && (fs.primaryContact['unique_id']||fs.primaryContact['Unique Id']) || null;
            }catch(e){ return null; }
        }

        // Source system-proposed plans from localStorage 'plans' (set earlier), fallback to minimal view
        function readSystemPlans(){
            let data = null;
            try { data = JSON.parse(localStorage.getItem('plans')); } catch(e) { data = null; }
            // Expected shapes:
            // 1) Array of plan groups; 2) Object with keys member1/member2/... each having {name, plans: []}; 3) { comprehensive_cover: {plans:[]}, member1: {...}, ... }
            // Overlay Family tab (best floater) plans from DOM under Family
            function readFloaterPlansFromDOM(){
                try {
                    const inputs = document.querySelectorAll('#floater-plans-container input.plan-checkbox');
                    return Array.from(inputs).map(cb => ({ name: cb.getAttribute('data-plan-name') }));
                } catch(e) { return []; }
            }
            let sys = (data && typeof data === 'object') ? data : {};
            const floater = readFloaterPlansFromDOM();
            if (Array.isArray(floater) && floater.length){
                sys.comprehensive_cover = {
                    name: 'Family',
                    plans: floater
                };
            }
            return sys;
        }

        function deriveMemberOrder(systemPlans){
            const order = [];
            // Prefer comprehensive cover first
            if (systemPlans && systemPlans.comprehensive_cover) order.push({ key:'comprehensive_cover', name:'Family' });
            const keys = Object.keys(systemPlans || {});
            keys.forEach(k => {
                if (k === 'comprehensive_cover') return;
                const val = systemPlans[k];
                if (val && (val.name || k)) order.push({ key:k, name: val.name || k });
            });
            // Fallback: if array provided
            if (!order.length && Array.isArray(systemPlans)) {
                systemPlans.forEach((grp, idx) => order.push({ key: String(idx), name: grp.name || `Group ${idx+1}` }));
            }
            return order;
        }

        function getRole(){
            try { return (localStorage.getItem('user_role') || 'agent').toLowerCase(); } catch(e) { return 'agent'; }
        }

        function buildSummaryTable(){
            const sys = readSystemPlans();
            const memberOrder = deriveMemberOrder(sys);
            const uid = getUniqueId();
            let saved = {};
            try { saved = JSON.parse(localStorage.getItem('agent_supervisor_selections')) || {}; } catch(e) { saved = {}; }

            // Live selections on page (from both Family and Individual tabs)
            const domChecked = Array.from(document.querySelectorAll('.plan-options-section .plan-checkbox:checked'))
                                  .map(cb => cb.getAttribute('data-plan-name'));
            const agentSelectedNow = new Set(domChecked);

            // Build proposed map expected by renderer
            const proposed = {};
            memberOrder.forEach(m => {
                let plans = [];
                if (sys[m.key]) {
                    if (Array.isArray(sys[m.key])) plans = sys[m.key];
                    else if (Array.isArray(sys[m.key].plans)) plans = sys[m.key].plans;
                }
                const names = plans.map(p => (p && p.name) ? p.name : (p || 'Plan')).filter(Boolean);
                proposed[m.key] = { name: m.name || m.key, plans: names };
            });

            // Agent selections: prefer live DOM state; else fallback to saved rowIds
            const agentSel = new Set();
            if (agentSelectedNow.size) {
                agentSelectedNow.forEach(n => agentSel.add(n));
            } else {
                Object.keys(saved.agent || {}).forEach(rowId => {
                    // rowId format: key__idx -> map back to name if available
                    const [key, idxStr] = rowId.split('__');
                    const idx = Number(idxStr);
                    const entry = proposed[key];
                    if (entry && Array.isArray(entry.plans) && entry.plans[idx]) agentSel.add(entry.plans[idx]);
                });
            }
            // Supervisor selections (read-only here)
            const supSel = new Set();
            Object.keys(saved.supervisor || {}).forEach(rowId => {
                const [key, idxStr] = rowId.split('__');
                const idx = Number(idxStr);
                const entry = proposed[key];
                if (entry && Array.isArray(entry.plans) && entry.plans[idx]) supSel.add(entry.plans[idx]);
            });

            if (summaryHost) {
                if (!memberOrder.length) {
                    summaryHost.innerHTML = '<p class="muted">No system-proposed plans available to summarize.</p>';
                } else {
                    window.renderPlanSelectionSummary(summaryHost, {
                        proposed,
                        agentSel,
                        supervisorSel: supSel,
                        mode: 'analysis'
                    });
                }
            }
            // Also serialize the summary to a plain object and send to backend for logging
            try {
                const summaryObj = {
                    unique_id: uid,
                    userId: (localStorage.getItem('loggedInUserId') || 'Unknown'),
                    mode: 'analysis',
                    timestamp: new Date().toISOString(),
                    proposed,
                    agent_selected: Array.from(agentSel || []),
                    supervisor_selected: Array.from(supSel || [])
                };
                // Print in browser for quick verification
                console.log('[PlanSelectionSummary]', summaryObj);
                // Fire-and-forget POST so server prints it to terminal
                if (uid) {
                    fetch(`/log_plan_summary/${uid}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(summaryObj)
                    }).catch(() => {});
                }
            } catch (e) { /* ignore logging errors */ }
            return { uid };
        }

        function collectSelections(){
            const role = getRole();
            const result = { agent:{}, supervisor:{} };
            if (role === 'supervisor') {
                // Read supervisor choices from enabled checkboxes
                summaryHost.querySelectorAll('input.supervisor-proposed').forEach(inp => {
                    if (inp.disabled) return; // ignore disabled
                    const key = inp.getAttribute('data-row');
                    if (inp.checked) result.supervisor[key] = true;
                });
                // carry forward agent's existing selections unchanged
                try {
                    const saved = JSON.parse(localStorage.getItem('agent_supervisor_selections')) || {};
                    result.agent = saved.agent || {};
                } catch(e) {}
            } else { // agent role
                // Build agent selections from live DOM (both tabs) mapped to rowIds via system plans
                const sys = readSystemPlans();
                const memberOrder = deriveMemberOrder(sys);
                const domChecked = Array.from(document.querySelectorAll('.plan-options-section .plan-checkbox:checked'))
                                      .map(cb => cb.getAttribute('data-plan-name'));
                const selectedNow = new Set(domChecked);
                memberOrder.forEach(m => {
                    let plans = [];
                    if (sys[m.key]) {
                        if (Array.isArray(sys[m.key])) plans = sys[m.key];
                        else if (Array.isArray(sys[m.key].plans)) plans = sys[m.key].plans;
                    }
                    plans.forEach((p, idx) => {
                        const rawName = (p && p.name) ? p.name : (p || 'Plan');
                        const rowId = `${m.key}__${idx}`;
                        if (selectedNow.has(rawName)) {
                            result.agent[rowId] = true;
                        }
                    });
                });
                // supervisor remains as previously saved
                try {
                    const saved = JSON.parse(localStorage.getItem('agent_supervisor_selections')) || {};
                    result.supervisor = saved.supervisor || {};
                } catch(e) {}
            }
            return result;
        }

        // JSON-backed summary rendering and agent PATCHing
        async function getUidForSummary(){
            // Prefer query params, then localStorage, then last path segment
            const qs = new URLSearchParams(window.location.search);
            const qp = qs.get('unique_id') || qs.get('uid');
            if (qp) return qp;
            try {
                const ls = localStorage.getItem('selectedUniqueId') || localStorage.getItem('currentUniqueId');
                if (ls) return ls;
            } catch {}
            try { return window.location.pathname.split('/').filter(Boolean).pop(); } catch(e) { return null; }
        }

        async function fetchPlanSummary(uid){
            const r = await fetch(`/plan_summary/${encodeURIComponent(uid)}`);
            if (!r.ok) throw new Error('Failed to load plan summary');
            return r.json();
        }

        // Build a 'proposed' map from current page state (Family + Individuals)
        function buildProposedFromPage(){
            // Reuse logic already present on the page
            const sys = readSystemPlans();
            const memberOrder = deriveMemberOrder(sys);
            const proposed = {};
            memberOrder.forEach(m => {
                let plans = [];
                if (sys[m.key]) {
                    if (Array.isArray(sys[m.key])) plans = sys[m.key];
                    else if (Array.isArray(sys[m.key].plans)) plans = sys[m.key].plans;
                }
                const names = plans.map(p => (p && p.name) ? p.name : (p || 'Plan')).filter(Boolean);
                proposed[m.key] = { name: m.name || m.key, plans: names };
            });
            // Fallback: if we could not derive Family plans from DOM/localStorage, try analysis JSON injected
            try {
                const noSections = Object.keys(proposed).length === 0;
                const fam = proposed['comprehensive_cover'];
                const hasFamily = fam && Array.isArray(fam.plans) && fam.plans.length > 0;
                if (noSections || !hasFamily) {
                    const analysisEl = document.getElementById('analysis-data-json');
                    if (analysisEl) {
                        const analysisData = JSON.parse(analysisEl.textContent || '{}');
                        const floater = (analysisData && analysisData.best_floater && Array.isArray(analysisData.best_floater.plans)) ? analysisData.best_floater.plans : [];
                        const names = floater.map(p => {
                            if (!p) return null;
                            if (typeof p === 'string') return p;
                            if (typeof p === 'object') return p['Plan Name'] || p.plan_name || p.name || p.plan || null;
                            return String(p);
                        }).filter(Boolean);
                        if (names.length) {
                            proposed['comprehensive_cover'] = { name: 'Family', plans: names };
                        }
                    }
                }
            } catch {}
            return proposed;
        }

        async function renderSummaryFromJson(mode){
            const uid = await getUidForSummary();
            if (!uid || !summaryHost) return;
            try {
                const data = await fetchPlanSummary(uid);
                // Always render from the latest dataset
                let dataset = data || {};
                let proposed = dataset.proposed || {};
                // Auto-init JSON if empty
                if (!proposed || Object.keys(proposed).length === 0){
                    try {
                        proposed = buildProposedFromPage();
                        const agentSelected = Array.from(document.querySelectorAll('.plan-options-section .plan-checkbox:checked')).map(cb => cb.getAttribute('data-plan-name'));
                        await fetch(`/plan_summary/${encodeURIComponent(uid)}/init_or_update`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ proposed, agent_selected: agentSelected })
                        });
                    } catch(e) { /* ignore init errors */ }
                    // Refetch after init
                    try {
                        const refreshed = await fetchPlanSummary(uid);
                        dataset = refreshed || dataset;
                        proposed = (refreshed && refreshed.proposed) || proposed;
                    } catch {}
                }
                // Prefer agent selections from refreshed dataset; fallback to live DOM if empty
                let agentSelArr = (dataset && dataset.agent_selected) || [];
                if (!agentSelArr || agentSelArr.length === 0) {
                    agentSelArr = Array.from(document.querySelectorAll('.plan-options-section .plan-checkbox:checked'))
                                        .map(cb => cb.getAttribute('data-plan-name'));
                }
                const agentSel = new Set(agentSelArr);
                const supSel = new Set((dataset && dataset.supervisor_selected) || []);
                const clientSel = new Set((dataset && dataset.client_agreed) || []);
                window.renderPlanSelectionSummary(summaryHost, {
                    proposed,
                    agentSel,
                    supervisorSel: supSel,
                    clientSel,
                    mode: mode || 'analysis'
                });
            } catch(e) {
                console.warn('Summary render failed:', e);
            }
        }

        // Proceed modal: show JSON-backed summary (analysis mode)
        if (proceedBtn) {
            proceedBtn.addEventListener('click', function(){
                renderSummaryFromJson('analysis');
                showModal();
            });
        }
        if (closeBtn) closeBtn.addEventListener('click', hideModal);
        if (cancelBtn) cancelBtn.addEventListener('click', hideModal);
        if (confirmBtn) {
            confirmBtn.addEventListener('click', function(){
                const role = getRole();
                const selections = collectSelections();
                try { localStorage.setItem('agent_supervisor_selections', JSON.stringify(selections)); } catch(e) {}

                const uid = getUniqueId();
                if (role === 'agent' && uid) {
                    // Build selected plan names from live page state (both tabs)
                    const selectedNames = Array.from(document.querySelectorAll('.plan-options-section .plan-checkbox:checked'))
                        .map(cb => cb.getAttribute('data-plan-name'));
                    if (!selectedNames.length) {
                        alert('Please select at least one plan before confirming.');
                        return;
                    }

                    // 1) Save agent-selected plans to backend
                    fetch(`/update_chosen_plans/${uid}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ selected_plans: selectedNames })
                    })
                    .then(r => r.json())
                    .then(res => {
                        if (!res || !res.success) throw new Error('Failed to save selected plans');
                        // 2) Move case to supervisor review
                        return fetch(`/update_approval_status/${uid}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-User-Id': (localStorage.getItem('loggedInUserId') || 'Unknown')
                            },
                            body: JSON.stringify({ status: 'SUP_REVIEW' })
                        });
                    })
                    .then(r => r.json())
                    .then(() => {
                        hideModal();
                        // Briefly notify and then refresh to reflect updated status widgets
                        try { alert('Submitted to supervisor for review. The page will refresh.'); } catch(e) {}
                        setTimeout(() => { window.location.reload(); }, 150);
                    })
                    .catch(err => {
                        console.error(err);
                        alert('Could not submit selection. Please try again.');
                    });
                } else {
                    // Supervisor role or missing UID: just close for now (extend to POST if you expose an endpoint)
                    hideModal();
                }
            });
        }
    })();
    </script>

    <script>
    // Fix for loading personal information when client_data is incomplete
    document.addEventListener('DOMContentLoaded', async function() {
        const personalInfoSection = document.getElementById('personalInfo');
        if (!personalInfoSection) return;
        
        // Get unique_id from the page title or URL
        const titleMatch = document.title.match(/- (.+)$/);
        const uniqueId = titleMatch ? titleMatch[1] : null;
        
        if (!uniqueId) {
            console.warn('Could not determine unique_id for personal info');
            return;
        }
        
        try {
            // Fetch the full submission data
            const resp = await fetch(`/api/agent/submission/${encodeURIComponent(uniqueId)}`);
            if (!resp.ok) {
                console.error('Failed to fetch submission data');
                return;
            }
            
            const data = await resp.json();
            console.log('Fetched submission data:', data);
            
            // Parse form_summary or use raw data
            let formData = null;
            try {
                if (typeof data.form_summary === 'string') {
                    formData = JSON.parse(data.form_summary);
                } else if (data.form_summary && typeof data.form_summary === 'object') {
                    formData = data.form_summary;
                }
            } catch (e) {
                console.error('Failed to parse form_summary:', e);
            }
            
            // CRITICAL: If form_summary is incomplete, use raw data
            if (!formData || Object.keys(formData).length < 5) {
                console.warn('form_summary incomplete, using raw API data');
                formData = data;
            }
            
            // Extract personal info from both nested and flat structures
            const getName = () => {
                return formData.applicant_name || 
                    formData.primaryContact?.applicant_name ||
                    formData['full_name'] ||
                    data.applicant_name ||
                    '—';
            };
            
            const getAge = () => {
                return formData['self-age'] ||
                    formData.primaryContact?.['self-age'] ||
                    data['self-age'] ||
                    '—';
            };
            
            const getBMI = () => {
                return formData['self-bmi'] ||
                    formData.primaryContact?.['self-bmi'] ||
                    data['self-bmi'] ||
                    '—';
            };
            
            const getGender = () => {
                const gender = formData.gender ||
                            formData.primaryContact?.gender ||
                            data.gender ||
                            '—';
                // Capitalize first letter
                return gender === '—' ? gender : gender.charAt(0).toUpperCase() + gender.slice(1).toLowerCase();
            };
            
            // Update the personal info section
            personalInfoSection.innerHTML = `
                <h2>Personal Information</h2>
                <ul>
                    <li><strong>Name:</strong> ${getName()}</li>
                    <li><strong>Age:</strong> ${getAge()}</li>
                    <li><strong>BMI:</strong> ${getBMI()}</li>
                    <li><strong>Gender:</strong> ${getGender()}</li>
                </ul>
            `;
            
            console.log('Personal info updated:', {
                name: getName(),
                age: getAge(),
                bmi: getBMI(),
                gender: getGender()
            });
            
        } catch (error) {
            console.error('Error loading personal information:', error);
            personalInfoSection.innerHTML = `
                <h2>Personal Information</h2>
                <p class="error">Failed to load personal information.</p>
            `;
        }
    });
    </script>
</body>
</html>
